namespace BaseScanner.Analyzers.Dependencies.Models;

/// <summary>
/// Result of vulnerability scanning
/// </summary>
public record VulnerabilityResult
{
    public required int TotalPackages { get; init; }
    public required int VulnerablePackages { get; init; }
    public required int OutdatedPackages { get; init; }
    public required int DeprecatedPackages { get; init; }
    public required List<PackageVulnerability> Vulnerabilities { get; init; }
    public required List<OutdatedPackage> Outdated { get; init; }
    public required List<DeprecatedPackage> Deprecated { get; init; }
    public required List<UpgradeRecommendation> Recommendations { get; init; }
    public required Dictionary<string, List<string>> TransitiveDependencyTree { get; init; }
    public required VulnerabilitySummary Summary { get; init; }
}

/// <summary>
/// Summary of vulnerability findings
/// </summary>
public record VulnerabilitySummary
{
    public required int Critical { get; init; }
    public required int High { get; init; }
    public required int Medium { get; init; }
    public required int Low { get; init; }
    public required double RiskScore { get; init; }
    public required string RiskLevel { get; init; }  // Critical, High, Medium, Low, Safe
}

/// <summary>
/// A security vulnerability in a package
/// </summary>
public record PackageVulnerability
{
    public required string PackageId { get; init; }
    public required string InstalledVersion { get; init; }
    public required string? CveId { get; init; }
    public required string? GhsaId { get; init; }
    public required string Severity { get; init; }  // Critical, High, Medium, Low
    public required double CvssScore { get; init; }
    public required string Description { get; init; }
    public required string? FixedInVersion { get; init; }
    public required bool IsTransitive { get; init; }
    public required string? TransitiveSource { get; init; }
    public required string? AdvisoryUrl { get; init; }
    public required DateTime? PublishedDate { get; init; }
    public required List<string> AffectedVersionRange { get; init; }
    public required List<string> Cwe { get; init; }
}

/// <summary>
/// An outdated package
/// </summary>
public record OutdatedPackage
{
    public required string PackageId { get; init; }
    public required string InstalledVersion { get; init; }
    public required string LatestVersion { get; init; }
    public required string? LatestStableVersion { get; init; }
    public required int MajorVersionsBehind { get; init; }
    public required int MinorVersionsBehind { get; init; }
    public required int PatchVersionsBehind { get; init; }
    public required bool IsDirectDependency { get; init; }
    public required DateTime? LastUpdated { get; init; }
    public required string UpdateUrgency { get; init; }  // Critical, High, Medium, Low
}

/// <summary>
/// A deprecated package
/// </summary>
public record DeprecatedPackage
{
    public required string PackageId { get; init; }
    public required string InstalledVersion { get; init; }
    public required string? DeprecationMessage { get; init; }
    public required string? AlternativePackage { get; init; }
    public required DateTime? DeprecatedDate { get; init; }
}

/// <summary>
/// Recommendation for upgrading a package
/// </summary>
public record UpgradeRecommendation
{
    public required string PackageId { get; init; }
    public required string CurrentVersion { get; init; }
    public required string RecommendedVersion { get; init; }
    public required string Reason { get; init; }
    public required UpgradeRisk Risk { get; init; }
    public required List<string> BreakingChanges { get; init; }
    public required List<string> SecurityFixes { get; init; }
    public required int Priority { get; init; }  // 1-10, higher is more urgent
}

/// <summary>
/// Risk assessment for an upgrade
/// </summary>
public record UpgradeRisk
{
    public required string Level { get; init; }  // Low, Medium, High
    public required bool HasBreakingChanges { get; init; }
    public required bool RequiresCodeChanges { get; init; }
    public required List<string> PotentialIssues { get; init; }
}

/// <summary>
/// A security advisory from vulnerability databases
/// </summary>
public record SecurityAdvisory
{
    public required string Id { get; init; }
    public required string? CveId { get; init; }
    public required string? GhsaId { get; init; }
    public required string PackageId { get; init; }
    public required string Severity { get; init; }
    public required double CvssScore { get; init; }
    public required string Description { get; init; }
    public required string? FixedInVersion { get; init; }
    public required List<string> AffectedVersions { get; init; }
    public required string? AdvisoryUrl { get; init; }
    public required DateTime? PublishedDate { get; init; }
    public required List<string> Cwe { get; init; }
}

/// <summary>
/// Package reference from project
/// </summary>
public record PackageReference
{
    public required string PackageId { get; init; }
    public required string Version { get; init; }
    public required bool IsDirectReference { get; init; }
    public required string? ProjectPath { get; init; }
    public List<string> TransitiveDependencies { get; init; } = new();
}

/// <summary>
/// Package metadata from NuGet
/// </summary>
public record PackageMetadata
{
    public required string PackageId { get; init; }
    public required string LatestVersion { get; init; }
    public required string? LatestStableVersion { get; init; }
    public required bool IsDeprecated { get; init; }
    public required string? DeprecationMessage { get; init; }
    public required string? AlternativePackage { get; init; }
    public required DateTime? LastUpdated { get; init; }
    public required List<string> AllVersions { get; init; }
}

/// <summary>
/// Severity levels for vulnerabilities
/// </summary>
public static class VulnerabilitySeverity
{
    public const string Critical = "Critical";
    public const string High = "High";
    public const string Medium = "Medium";
    public const string Low = "Low";

    public static string FromCvss(double cvssScore)
    {
        return cvssScore switch
        {
            >= 9.0 => Critical,
            >= 7.0 => High,
            >= 4.0 => Medium,
            _ => Low
        };
    }

    public static int ToSortOrder(string severity)
    {
        return severity switch
        {
            Critical => 0,
            High => 1,
            Medium => 2,
            Low => 3,
            _ => 4
        };
    }
}
